name: "Development Build"
on: push
 
jobs:

  DeployDev:
    name: Deploy
   
    runs-on: ubuntu-latest
    environment:
      name: Development

    steps:
      - uses: actions/checkout@master
      - name: Upload to S3
        run: |
          aws s3 ls

          
          #aws s3 mb s3://latest-test-our-fita
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_DEFAULT_REGION: 'us-west-2'
      
     
      - name: Deploy in EC2
        env:
          PRIVATE_KEY: ${{ secrets.AWS_PRIVATE_KEY  }}
                 
          HOST_NAME : ${vars.DNS_ADDR}
         
          USER_NAME : ${vars.USER_NAME}
    
        
        run: |
          echo "$PRIVATE_KEY" > private_key && chmod 600 private_key
          ssh -o StrictHostKeyChecking=no -i private_key ${vars.USER_NAME}@${vars.DNS_ADDR} "
            sudo apt-get update&
            sudo apt-get install ca-certificates curl gnupg&
            sudo install -m 0755 -d /etc/apt/keyrings&
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg&
            sudo chmod a+r /etc/apt/keyrings/docker.gpg&
            echo \&
           "deb [arch="$(dpkg --print-architecture)" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \ &
           "$(. /etc/os-release && echo "$VERSION_CODENAME")" stable" | \ &
            sudo tee /etc/apt/sources.list.d/docker.list > /dev/null &
            sudo apt-get update "&
            sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin"
  
        
    
